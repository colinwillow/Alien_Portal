<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Import the p5.js library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
  
  <!-- Import three.js libraries -->
  <script type="importmap">
    {
      "imports": {
        "three": "https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.module.min.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.128.0/examples/jsm/"
      }
    }
  </script>
  
  <title>Particle System with 3D Model</title>
  <style>
    /* A simple reset to make the canvas fill the screen */
    body {
      padding: 0;
      margin: 0;
      background-color: #000; /* Changed from #333 to black */
      overflow: hidden; /* Hide scrollbars */
    }
    
    /* Main container to hold both canvases */
    main {
      position: relative;
      width: 100vw;
      height: 100vh;
    }
    
    /* Canvas containers will be layered on top of each other */
    #three-canvas-container,
    #p5-canvas-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    
    /* 3D model goes in the back */
    #three-canvas-container {
      z-index: 5;
    }
    
    /* p5.js particles go in the front */
    #p5-canvas-container {
      z-index: 10;
    }
  </style>
</head>

<body>
  <main>
    <!-- 3D model will be rendered here -->
    <div id="three-canvas-container"></div>
    <!-- p5.js particles will be rendered here -->
    <div id="p5-canvas-container"></div>
  </main>

  <!-- =============================================== -->
  <!-- SCRIPT 1: Three.js 3D Scene Setup -->
  <!-- =============================================== -->
  <script type="module">
    import * as THREE from 'three';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    let scene, camera, renderer, clock, mixer, model;

    // Add a unique query parameter to bust the cache and reload the GLB
    const glbUrl = "https://raw.githubusercontent.com/colinwillow/glb_characters/main/alien_meditate_05.glb?v=" + new Date().getTime();
    
    function initThree() {
      const container = document.getElementById('three-canvas-container');
      
      // 1. Scene
      scene = new THREE.Scene();
      clock = new THREE.Clock();

      // 2. Camera
      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.z = 3; // Pull camera back to see the model

      // 3. Renderer
      renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true }); // alpha:true for transparent background
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setSize(window.innerWidth, window.innerHeight);
      container.appendChild(renderer.domElement);

      // 4. Lighting
      const ambientLight = new THREE.AmbientLight(0xffffff, 1.5); // Soft white light (was 0.5)
      scene.add(ambientLight);
      const directionalLight = new THREE.DirectionalLight(0xffffff, 2.0); // Brighter light (was 1)
      directionalLight.position.set(0, 1, 1);
      scene.add(directionalLight);

      // 5. Controls (optional, but helpful for positioning)
      // const controls = new OrbitControls(camera, renderer.domElement);
      // controls.enableDamping = true;
      
      // 6. Load Model
      const loader = new GLTFLoader();
      loader.load(glbUrl, (gltf) => {
        model = gltf.scene;
        model.scale.set(1.5, 1.5, 1.5); // Scale the model up a bit
        model.position.y = 0; // Move it down
        model.position.z = 1; // Move it down
        scene.add(model);
        
        console.log("GLB Model loaded successfully.");

        // 7. Play Animation
        if (gltf.animations && gltf.animations.length) {
          mixer = new THREE.AnimationMixer(model);
          const action = mixer.clipAction(gltf.animations[0]); // Play the first animation
          action.play();
          console.log("Animation started.");
        } else {
          console.log("No animations found in GLB.");
        }
        
      }, undefined, (error) => {
        console.error("An error happened loading the GLB:", error);
      });

      // 8. Start Animation Loop
      animate();
    }

    // 9. Animation Loop
    function animate() {
      requestAnimationFrame(animate);
      
      const delta = clock.getDelta();

      // Update animation
      if (mixer) {
        mixer.update(delta);
      }
      
      // Animate model rotation (optional)
      if (model) {
         // model.rotation.y += 0.005; // Gently rotate the model - COMMENTED OUT as requested
      }

      // controls.update(); // Only if controls are enabled
      renderer.render(scene, camera);
    }

    // 10. Handle Window Resizing for BOTH canvases
    function onWindowResize() {
      // Update 3D Camera
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
      
      // Update p5.js Canvas (p5.js 'resizeCanvas' function is global)
      if (window.resizeCanvas) {
        window.resizeCanvas(window.innerWidth, window.innerHeight);
      }
    }

    // Start everything
    initThree();
    window.addEventListener('resize', onWindowResize);
    
  </script>

  <!-- =============================================== -->
  <!-- SCRIPT 2: Your Original p5.js Particle Code -->
  <!-- (Slightly modified setup(), removed image load) -->
  <!-- =============================================== -->
  <script>
    let vehicles = [];
    
    // These arrays will hold the target coordinates for our vehicles.
    let targetX = [];
    let targetY = [];

    // The total number of vehicles. 
    // This MUST match the number of data points in your arrays.
    const numVehicles = 2383;

    let scale;
    let squigX;
    let squigY;
    
    // This will make the whole particle formation move up and down
    let formationOffsetY = 0;

    // --- NO PRELOAD NEEDED ---
    // We removed the image loading

    // --- DATA LOADING ---
    function generateFormationData() {
      console.log("Generating placeholder data...");
      let maxRadius = 250;
      for (let j = 0; j < numVehicles; j++) {
        let r = maxRadius * sqrt(random(1)); 
        let angle = random(TWO_PI);
        targetX[j] = cos(angle) * r;
        targetY[j] = sin(angle) * r;
      }
    }

    function setup() {
      // *** MODIFIED ***
      // Create the canvas and parent it to the p5-canvas-container
      let p5Canvas = createCanvas(windowWidth, windowHeight);
      p5Canvas.parent('p5-canvas-container');
      
      // 1. Generate/load the data into the arrays
      generateFormationData();
      
      // 2. Create a vehicle for each data point
      loadVehicles();
      
      rectMode(CENTER);
      textAlign(CENTER);
      // imageMode(CENTER); // No longer needed
      scale = 1.5;
    }

    function loadVehicles() {
      // Create one vehicle for each data point
      for (var j = 0; j < numVehicles; j++) {
        // Start them at random positions
        var v = new Vehicle(random(width), random(height), random(1, 7));
        vehicles.push(v);
      }
    }

    function draw() {
      // *** MODIFIED ***
      // We need to clear the p5 canvas, but make it transparent
      // so we can see the 3D model behind it.
      // clear() resets the canvas to be fully transparent.
      clear(); 
      
      // Your original transparent background for the trail effect
      push();
      // *** MODIFIED ***
      // The alpha value MUST be less than 255 to see the 3D model behind this canvas.
      // 255 is fully opaque. 100 gives a nice trail effect and is semi-transparent.
      fill(0, 100); // Set to black (0) but semi-transparent (100) to see the 3D model
      rect(width / 2, height / 2, width, height);
      pop();

      // --- Removed image drawing block ---

      // Adjust scale based on window size
      scale = 0.5 * width / 540;
      
      // --- NEW: Calculate global oscillation for the formation ---
      // These values control the "floating" effect.
      // You can adjust 'oscillationSpeed' and 'oscillationAmplitude'
      // to match the GLB model's animation.
      let oscillationSpeed = 0.08; // How fast it moves up and down
      let oscillationAmplitude = 0; // How far it moves (in pixels)
      formationOffsetY = sin(frameCount * oscillationSpeed) * oscillationAmplitude;
      // --- End new block ---

      for (var i = 0; i < vehicles.length; i++) {
        var v = vehicles[i];
        
        v.sizeBall();
        squigX = sin(frameCount / 10000.0 * i);
        squigY = cos(frameCount / 20000.0 * i);
        
        if (targetX[i] !== undefined && targetY[i] !== undefined) {
          let target_x = targetX[i] * squigX * scale + width / 2;
          
          // *** MODIFIED ***
          // Added the formationOffsetY to make the whole shape move
          let target_y = targetY[i] * squigY * scale + height / 2 + formationOffsetY;
          
          v.update(target_x, target_y);
          v.show();
          v.behaviors();
        }
      }

      // --- Debug Text ---
      push();
      textSize(20);
      fill(255, 100);
      noStroke();
      text(vehicles.length + " particles", width / 2, height - 90);
      text("FPS: " + int(frameRate()), width / 2, height - 65);
      pop();
    }

    // --- REMOVED p5's windowResized() ---
    // It's now handled by the three.js script's onWindowResize function
    // function windowResized() {
    //   resizeCanvas(windowWidth, windowHeight);
    // }

    // Add new vehicles by dragging the mouse
    function mouseDragged() {
      if (vehicles.length < 5000) { // Add a limit
        var v = new Vehicle(mouseX, mouseY, 7);
        vehicles.push(v);
        
        targetX.push(random(-200, 200) * scale);
        targetY.push(random(-200, 200) * scale);
      }
    }

    // ===============================================
    // VEHICLE CLASS (Particle)
    // (This is your original code, 100% unchanged)
    // ===============================================
    function Vehicle(x, y, r) {
      this.position = createVector(x, y);
      this.velocity = createVector(0, 0);
      this.acceleration = createVector(0, 0);
      this.mouse = createVector(mouseX, mouseY);
      this.sizeL = 1;
      this.sizeH = 4;
      this.sizeL2 = 1;
      this.sizeH2 = 4;

      this.maxSpeed = random(11, 12);
      this.maxForce = this.maxSpeed * 0.05;

      this.r = r;
    }

    Vehicle.prototype.update = function (x, y, z) {
      this.position.add(this.velocity);
      this.velocity.add(this.acceleration);
      this.acceleration.mult(0);

      this.target = createVector(x, y, z);

      this.sizeL = lerp(this.sizeL, this.sizeL2, 0.05);
      this.sizeH = lerp(this.sizeH, this.sizeH2, 0.05);
    }

    Vehicle.prototype.sizeBall = function () {
      this.sizeL2 = 0;
      this.sizeH2 = 10;
    }
    Vehicle.prototype.sizeWord = function () {
      this.sizeL2 = 4;
      this.sizeH2 = 4;
    }

    Vehicle.prototype.show = function () {
      var origin = createVector(width / 2, height / 2)
      var vel = this.velocity.mag();
      var distance = origin.sub(this.position);
      var distMag = distance.mag();

      var colR = map(this.velocity.x, 0, 10, 230, 51);
      var colG = map(this.velocity.y, 0, 10, 220, 151);
      var colB = map(vel, 0, 10, 250, 134);
      var radius = map(vel, 4, 0, 0, 4);
      var alpha = map(vel, 0, 20, 200, 00);

      var size = map(distMag, 100, 0, this.sizeL, this.sizeH);

      push();
      noStroke();
      translate(this.position.x, this.position.y);
      fill(colR * 0.96 - 50 - 20, colG * 0.98 - 20, colB * 1.3 + 50 - 20, alpha);
      ellipse(0, 0, size, size);
      pop();
    }

    Vehicle.prototype.flee = function (target) {
      var desired = p5.Vector.sub(target, this.position);
      var distance = desired.mag();
      if (distance < 100) {
        desired.setMag(this.maxSpeed);
        desired.mult(-1);
        var steer = p5.Vector.sub(desired, this.velocity);
        steer.limit(this.maxForce);

        return steer;
      }
      return createVector(0, 0);
    }

    Vehicle.prototype.arrive = function (target) {
      var desired = p5.Vector.sub(target, this.position);
      var distance = desired.mag();
      var speed = this.maxSpeed;
      if (distance < 500) {
        speed = map(distance, 0, 100, 0, this.maxSpeed);
      }
      desired.setMag(speed);
      var steer = p5.Vector.sub(desired, this.velocity);
      steer.limit(this.maxForce);
      return steer;
    }

    Vehicle.prototype.behaviors = function () {
      var arrive = this.arrive(this.target);
      var mouse = createVector(mouseX, mouseY);
      var flee = this.flee(mouse);

      arrive.mult(1);
      flee.mult(2);

      this.applyForce(arrive);
      this.applyForce(flee);
    }

    Vehicle.prototype.applyForce = function (force) {
      this.acceleration.add(force);
    }

    Vehicle.prototype.edges = function () {
      if (this.position.x <= -width / 2 || this.position.x >= width / 2) {
        this.velocity.x *= -1;
      }
      if (this.position.y <= -height / 2 || this.position.y >= height / 2) {
        this.velocity.y *= -1;
      }
    }
  </script>
</body>
</html>